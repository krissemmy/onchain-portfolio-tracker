<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sim APIs Wallet UI - Portfolio across multiple wallets">
    <meta name="theme-color" content="#0b0e1f">
    <title>Sim APIs Wallet UI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
</head>
<body>
<div class="mobile-container">
    <header class="app-header">
        <div class="profile-pic-placeholder"></div>
        <div class="header-title">Wallet</div>
        <div class="settings-icon"></div>
    </header>

    <section class="total-balance-section">
        <p class="total-balance-amount" id="total-balance-amount">$0.00</p>
        <p class="total-balance-pnl pnl-neutral" id="total-balance-pnl" style="display:none;">$0.00 24h</p>
        <p class="total-balance-label" id="total-balance-label">
            Add one or more EVM addresses below
        </p>
    </section>

    <!-- Multi-address input -->
    <section class="address-section">
        <div class="address-bar">
            <div class="address-input-container">
                <div class="address-chips" id="address-chips">
                    <input type="text"
                           id="address-input"
                           placeholder="Add wallet address and press Enter" />
                </div>
            </div>
            <button class="address-search-button" id="address-search-button" type="button">
                Search
            </button>
        </div>
    
        <!-- Filter row, visually nested under address bar -->
        <div class="filter-bar">
            <input
                type="text"
                id="token-filter-input"
                class="filter-input"
                placeholder="Filter by token name or contract address (optional)" />
        </div>
    </section>

    <nav class="tabs">
        <button class="tab-button active" data-tab="tokens" id="tab-tokens">Tokens</button>
        <button class="tab-button" data-tab="activity" id="tab-activity">Activity</button>
    </nav>

    <main class="tab-content">
        <!-- Tokens Tab Pane -->
        <div id="tokens" class="tab-pane active">
            <div id="tokens-list">
                <p style="text-align: center; padding-top: 30px; color: var(--color-text-muted);">
                    Add one or more wallet addresses above to see token balances.
                </p>
            </div>
        </div>

        <!-- Activity Tab Pane -->
        <div id="activity" class="tab-pane">
            <div class="info-banner">
                Solana and Eclipse activities are not available yet in Sim APIs,
                so this tab only shows EVM activity.
            </div>
            <div id="activity-list">
                <p style="text-align: center; padding-top: 30px; color: var(--color-text-muted);">
                    Add one or more wallet addresses above to see activity.
                </p>
            </div>
        </div>
    </main>
</div>

<script>
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanes = document.querySelectorAll('.tab-pane');
    const chipsContainer = document.getElementById('address-chips');
    const addressInput = document.getElementById('address-input');
    const searchButton = document.getElementById('address-search-button');
    const tokenFilterInput = document.getElementById('token-filter-input');

    let tokenFilterState = '';

    const totalBalanceAmountEl = document.getElementById('total-balance-amount');
    const totalBalancePnlEl = document.getElementById('total-balance-pnl');
    const totalBalanceLabelEl = document.getElementById('total-balance-label');

    const tokensListEl = document.getElementById('tokens-list');
    const activityListEl = document.getElementById('activity-list');

    let addressesState = [];
    let currentTab = 'tokens';
    let isLoading = false;

    function setLoading(loading) {
        isLoading = loading;
        searchButton.disabled = loading;
        searchButton.textContent = loading ? 'Loading...' : 'Search';
    }

    function renderChips() {
        chipsContainer.innerHTML = '';
        addressesState.forEach(addr => {
            const chip = document.createElement('span');
            chip.className = 'address-chip';
            chip.dataset.address = addr;
            const short = addr.length > 10
                ? addr.substring(0, 6) + '...' + addr.substring(addr.length - 4)
                : addr;
            chip.innerHTML = `
                <span class="address-chip-text">${short}</span>
                <button class="address-chip-remove" type="button" data-address="${addr}">×</button>
            `;
            chipsContainer.appendChild(chip);
        });
        chipsContainer.appendChild(addressInput);
    }

    function renderHeader(data) {
        const total = data.totalWalletUSDValue || '$0.00';
        totalBalanceAmountEl.textContent = total;

        const pnlText = data.totalPnLUSDFormatted;
        if (pnlText) {
            totalBalancePnlEl.textContent = `${pnlText} 24h`;
            totalBalancePnlEl.className = `total-balance-pnl ${data.totalPnLClass || 'pnl-neutral'}`;
            totalBalancePnlEl.style.display = 'block';
        } else {
            totalBalancePnlEl.style.display = 'none';
        }

        if (data.walletAddresses && data.walletAddresses.length > 0) {
            const n = data.walletAddresses.length;
            totalBalanceLabelEl.textContent = `Tracking ${n} wallet${n > 1 ? 's' : ''}`;
        } else {
            totalBalanceLabelEl.textContent = 'Add one or more EVM addresses below';
        }
    }

    function renderTokens(tokens) {
        if (!tokens || tokens.length === 0) {
            if (addressesState.length > 0) {
                tokensListEl.innerHTML = `
                    <p style="text-align: center; padding-top: 30px; color: var(--color-text-muted);">
                        No tokens found for the selected wallets.
                    </p>
                `;
            } else {
                tokensListEl.innerHTML = `
                    <p style="text-align: center; padding-top: 30px; color: var(--color-text-muted);">
                        Add one or more wallet addresses above to see token balances.
                    </p>
                `;
            }
            return;
        }

        let html = '';
        tokens.forEach(token => {
            const logo = token.token_metadata && token.token_metadata.logo;
            const url = token.token_metadata && token.token_metadata.url;
            const name = token.name || token.symbol || 'Token';
            const symbol = token.symbol || '';
            const valueUSD = token.valueUSDFormatted || (token.value_usd != null ? token.value_usd : 'N/A');
            const amount = token.amountFormatted || token.amount || '';
            const chainLabel = token.chain_label || '';
            const badgeLabel = token.change24hBadgeLabel;
            const badgeClass = token.change24hBadgeClass;

            html += `
                <div class="list-item">
                    ${logo ? `
                        <img src="${logo}"
                             alt="${symbol || 'Token'} Logo"
                             class="item-icon-placeholder"
                             style="object-fit: contain; padding: 6px;">
                    ` : `
                        <div class="item-icon-placeholder">
                            ${(symbol || '?').slice(0, 4)}
                        </div>
                    `}
                    <div class="item-info">
                        ${url ? `
                            <p class="item-name">
                                <a href="${url}" target="_blank" style="color: inherit; text-decoration: none;">
                                    ${name}
                                </a>
                            </p>
                        ` : `
                            <p class="item-name">${name}</p>
                        `}
                        ${chainLabel ? `<p class="item-chain">${chainLabel}</p>` : ''}
                    </div>
                    <div class="item-value-right">
                        <p class="item-usd-value">
                            <strong>${valueUSD}</strong>
                        </p>
                        <p class="item-sub-info">
                            ${amount} ${symbol}
                        </p>
                        ${badgeLabel ? `
                            <span class="badge ${badgeClass}">
                                ${badgeLabel} 24h
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        tokensListEl.innerHTML = html;
    }

    function renderActivities(activities) {
        if (!activities || activities.length === 0) {
            if (addressesState.length > 0) {
                activityListEl.innerHTML = `
                    <p style="text-align: center; padding-top: 30px; color: var(--color-text-muted);">
                        No activity found for the selected wallets.
                    </p>
                `;
            } else {
                activityListEl.innerHTML = `
                    <p style="text-align: center; padding-top: 30px; color: var(--color-text-muted);">
                        Add one or more wallet addresses above to see activity.
                    </p>
                `;
            }
            return;
        }

        let html = '';
        activities.forEach(activity => {
            const icon = activity.type === 'receive' ? '↓'
                : activity.type === 'send' ? '↑'
                : activity.type === 'call' ? '⇆'
                : '✓';

            const title = activity.activityTitle || (activity.type || '').toUpperCase();
            const colorClass = activity.activityColorClass || activity.type || '';
            const partyShort = activity.partyAddressShort;
            const partyLabel = activity.partyLabel || '';
            const srcWallet = activity.source_wallet;
            const blockTime = activity.blockTimeDisplay || '';
            const amountDisplay = activity.amountDisplay;
            const symbolDisplay = activity.symbolDisplay;
            const dirPrefix = activity.directionPrefix || '';

            html += `
                <div class="list-item">
                    <div class="item-icon-placeholder">${icon}</div>
                    <div class="item-info">
                        <p class="item-name activity-direction ${colorClass}">
                            ${title}
                        </p>
                        <p class="activity-address">
                            ${partyShort ? `
                                ${partyLabel}
                                <span class="mono">${partyShort}</span>
                            ` : 'Interaction'}
                            ${srcWallet ? `
                                <span class="mono" style="margin-left: 6px; font-size: 0.75em;">
                                    (${srcWallet.substring(0, 6)}...${srcWallet.substring(srcWallet.length - 4)})
                                </span>
                            ` : ''}
                        </p>
                        <p class="activity-timestamp">
                            <span class="mono">${blockTime}</span>
                        </p>
                    </div>
                    <div class="item-value-right">
                        ${activity.type === 'call'
                            ? `<p class="activity-amount-right ${colorClass}" style="font-family: var(--font-primary);">Interaction</p>`
                            : amountDisplay
                                ? `<p class="activity-amount-right ${colorClass}">
                                       ${dirPrefix}${amountDisplay}
                                       ${symbolDisplay ? `<span class="mono">${symbolDisplay}</span>` : ''}
                                   </p>`
                                : ''
                        }
                    </div>
                </div>
            `;
        });

        activityListEl.innerHTML = html;
    }

    async function fetchPortfolio() {
        if (addressesState.length === 0) {
            renderHeader({
                walletAddresses: [],
                totalWalletUSDValue: '$0.00',
                totalPnLUSDFormatted: null,
                totalPnLClass: 'pnl-neutral',
            });
            renderTokens([]);
            renderActivities([]);
            return;
        }

        setLoading(true);
        try {
            const res = await fetch('/api/portfolio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    walletAddresses: addressesState,
                    tab: currentTab,
                    tokenFilter: tokenFilterState || null,
                }),
            });
            const data = await res.json();

            renderHeader(data);
            renderTokens(data.tokens || []);
            renderActivities(data.activities || []);
        } catch (err) {
            console.error(err);
            // Minimal error UI
            renderHeader({
                walletAddresses: addressesState,
                totalWalletUSDValue: '$0.00',
                totalPnLUSDFormatted: null,
                totalPnLClass: 'pnl-neutral',
            });
            if (currentTab === 'tokens') {
                tokensListEl.innerHTML = `
                    <p style="text-align: center; padding-top: 30px; color: var(--color-text-muted);">
                        Error fetching data. Please try again.
                    </p>
                `;
            } else {
                activityListEl.innerHTML = `
                    <p style="text-align: center; padding-top: 30px; color: var(--color-text-muted);">
                        Error fetching data. Please try again.
                    </p>
                `;
            }
        } finally {
            setLoading(false);
        }
    }

    // Tab switching (no reload)
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.dataset.tab;
            if (tab === currentTab) return;
            currentTab = tab;

            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));

            button.classList.add('active');
            const pane = document.getElementById(tab);
            if (pane) pane.classList.add('active');

            // Re-fetch for the new tab using same addresses
            fetchPortfolio();
        });
    });

    // Add address locally on Enter (no API call yet)
    addressInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = addressInput.value.trim();
            if (!value) return;
            const lower = value.toLowerCase();
            const exists = addressesState.some(a => a.toLowerCase() === lower);
            if (!exists) {
                addressesState.push(value);
                renderChips();
            }
            addressInput.value = '';
        }
    });

    // Track token filter (case-insensitive on backend)
    tokenFilterInput.addEventListener('input', (e) => {
        tokenFilterState = e.target.value.trim();
    });

    // Pressing Enter in the filter box also fetches portfolio
    tokenFilterInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            fetchPortfolio();
        }
    });

    // Remove chip locally
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('address-chip-remove')) {
            const addr = e.target.getAttribute('data-address');
            addressesState = addressesState.filter(a => a !== addr);
            renderChips();
        }
    });

    // Search button triggers the API call (no URL changes, no reload)
    searchButton.addEventListener('click', () => {
        fetchPortfolio();
    });

    // Initial setup
    document.addEventListener('DOMContentLoaded', () => {
        renderChips();
    });
</script>
</body>
</html>
